# トークメモ自動移動システム - セットアップガイド

## 📋 概要

Google MeetのGeminiメモを自動的に学籍番号フォルダに振り分けるシステムです。

### 機能
- ✅ Meet RecordingsフォルダからGeminiメモを自動取得
- ✅ Googleカレンダーのメモ欄から学籍番号を抽出
- ✅ 学籍番号フォルダにメモを自動移動
- ✅ フォルダが存在しない場合は自動作成
- ✅ 複数Googleアカウント対応
- ✅ 2時間おき自動実行

---

## 🚀 セットアップ手順

### 1. Google Apps Scriptプロジェクトを作成

1. **Google Driveを開く**
   ```
   https://drive.google.com/
   ```

2. **新規作成 → その他 → Google Apps Script** をクリック

3. **プロジェクト名を設定**
   - プロジェクト名: `WannaV - トークメモ自動移動`

4. **コードをコピー**
   - `/home/user/webapp/gas/MemoAutoMove.gs` の内容を全てコピー
   - Apps Scriptエディタに貼り付け

5. **保存**
   - `Ctrl + S` または 💾 アイコンをクリック

---

### 2. 必要な設定を確認

スクリプト内の以下の定数を確認してください：

```javascript
// アカウントマッピングスプレッドシートID
const ACCOUNT_MAPPING_SPREADSHEET_ID = '1gFrIbkRxNcpKuT0vRNfaUdSrJWynlCdfqhGQz9vWwWo';

// 学籍番号フォルダの親フォルダID
const STUDENT_FOLDERS_PARENT_ID = '18YfaP1CrW5Lq_sAeVAR56tIRZR3GwMDS';

// 学籍番号の正規表現パターン
const STUDENT_ID_PATTERN = /[A-Z]{4}\d{6}-[A-Z]{2}/g;
```

これらの値は既に設定済みですが、変更が必要な場合は修正してください。

---

### 3. 権限の付与

1. **テスト実行**
   - 関数: `testCalendarEvents` を選択
   - 「実行」ボタンをクリック

2. **権限の確認**
   - 「権限を確認」ボタンをクリック
   - Googleアカウントを選択
   - 「詳細」→「WannaV - トークメモ自動移動（安全ではないページ）に移動」をクリック
   - 「許可」をクリック

3. **必要な権限**
   - ✅ Google Driveのファイルとフォルダへのアクセス
   - ✅ Googleカレンダーの閲覧
   - ✅ Googleスプレッドシートの閲覧

---

### 4. トリガーの設定（2時間おき自動実行）

1. **トリガー画面を開く**
   - 左メニューの「トリガー」（⏰アイコン）をクリック

2. **トリガーを追加**
   - 右下の「+ トリガーを追加」ボタンをクリック

3. **設定内容**
   - **実行する関数を選択**: `autoMoveMemos`
   - **イベントのソースを選択**: `時間主導型`
   - **時間ベースのトリガーのタイプを選択**: `時間ベースのタイマー`
   - **時間の間隔を選択**: `2時間おき`

4. **保存**
   - 「保存」ボタンをクリック

---

### 5. 動作確認

#### **テスト1: カレンダーイベントの確認**
```
1. 関数: testCalendarEvents を選択
2. 「実行」ボタンをクリック
3. 「実行ログ」を確認
   - カレンダーイベントが表示される
   - 学籍番号が抽出されていることを確認
```

#### **テスト2: トークメモの移動テスト**
```
1. 関数: testAutoMoveMemos を選択
2. 「実行」ボタンをクリック
3. 「実行ログ」を確認
   - Meet Recordingsフォルダからファイルが検出される
   - 学籍番号が抽出される
   - 移動先フォルダが表示される
```

#### **テスト3: 本番実行テスト**
```
1. 関数: autoMoveMemos を選択
2. 「実行」ボタンをクリック
3. 「実行ログ」を確認
   - 処理対象アカウント数が表示される
   - 各アカウントの処理結果が表示される
   - 総処理数、総移動数、総エラー数が表示される
```

---

## 📊 アカウントマッピングスプレッドシートの形式

スプレッドシート: `https://docs.google.com/spreadsheets/d/1gFrIbkRxNcpKuT0vRNfaUdSrJWynlCdfqhGQz9vWwWo/edit`

| A列: メールアドレス | B列: Meet RecordingsフォルダURL |
|-------------------|-------------------------------|
| kh0nq1016@gmail.com | https://drive.google.com/drive/folders/... |
| example@gmail.com | https://drive.google.com/drive/folders/... |

**注意事項**:
- 1行目はヘッダー行（スキップされます）
- A列が空の行はスキップされます
- B列のURLからフォルダIDが自動抽出されます

---

## 📁 学籍番号フォルダの構造

親フォルダ: `https://drive.google.com/drive/folders/18YfaP1CrW5Lq_sAeVAR56tIRZR3GwMDS`

```
学籍番号フォルダ親フォルダ/
├── OLTS240488-AR/
│   ├── Geminiメモ1.gdoc
│   ├── Geminiメモ2.gdoc
│   └── ...
├── OLST230057-TQ/
│   ├── Geminiメモ1.gdoc
│   └── ...
└── [自動作成される新しいフォルダ]
```

---

## 🔍 カレンダーのメモ欄の形式

Googleカレンダーのイベントの「説明」欄に学籍番号を記載してください。

**例:**
```
予約者:
林田悟樹
kh0nq1016@gmail.com

学籍番号
OLTS240219-XC

10 分前

きょうへい先生
```

**学籍番号の形式**: `[A-Z]{4}\d{6}-[A-Z]{2}`
- 例: `OLTS240488-AR`, `OLST230057-TQ`

---

## ⚠️ トラブルシューティング

### **問題1: 学籍番号が見つからない**
- カレンダーのメモ欄に学籍番号が記載されているか確認
- 学籍番号の形式が正しいか確認（例: `OLTS240488-AR`）
- イベントの時刻とメモファイルの作成時刻が近いか確認（±30分以内）

### **問題2: フォルダが見つからない**
- アカウントマッピングスプレッドシートのURLが正しいか確認
- Meet RecordingsフォルダのURLが正しいか確認
- 学籍番号フォルダの親フォルダIDが正しいか確認

### **問題3: 権限エラー**
- Apps Scriptに必要な権限が付与されているか確認
- 対象のフォルダに対する編集権限があるか確認

### **問題4: トリガーが動作しない**
- トリガーが正しく設定されているか確認
- 「実行数」で過去の実行履歴とエラーログを確認

---

## 📈 実行ログの確認

1. **Apps Scriptエディタを開く**
2. **左メニューの「実行数」をクリック**
3. **過去の実行履歴を確認**
   - 実行日時
   - 実行時間
   - 成功/失敗
   - エラーメッセージ

---

## 🔄 定期実行の停止/再開

### **停止**
1. 左メニューの「トリガー」をクリック
2. 対象のトリガーの右側にある「︙」をクリック
3. 「削除」をクリック

### **再開**
1. 左メニューの「トリガー」をクリック
2. 「+ トリガーを追加」ボタンをクリック
3. 設定を行って保存

---

## 📞 サポート

問題が発生した場合は、以下の情報を含めて報告してください：

1. **エラーメッセージ**: 実行ログに表示されたエラー
2. **実行関数**: どの関数を実行したか
3. **環境情報**: 
   - アカウント数
   - 処理対象のファイル数
   - カレンダーイベントの有無

---

## 🎯 次のステップ

- [ ] テスト実行で動作確認
- [ ] トリガー設定で自動実行開始
- [ ] 1日後に実行ログを確認
- [ ] 問題があれば設定を調整

システムが正常に動作している場合、特別な操作は不要です。2時間おきに自動的にメモが整理されます。
