# トークメモ自動移動 - 処理フロー詳細

## 📊 完全な処理フロー

```
[Meet RecordingsフォルダからGeminiメモを取得]
    ↓
[ファイル形式を確認]
    ├─ Googleドキュメント → 処理継続
    └─ その他の形式 → ❌ スキップ
    ↓
[ファイルの作成日時を取得]
    ↓
[Googleカレンダーから学籍番号を検索]
    ├─ 作成日時の前後30分のイベントを検索
    ├─ イベントの説明欄を確認
    └─ 学籍番号パターン (例: OLTS240488-AR) をマッチング
    ↓
[学籍番号が見つかった？]
    │
    ├─ ✅ YES (学籍番号あり)
    │   ↓
    │   [学籍番号フォルダを取得または作成]
    │       ├─ 親フォルダ内を検索
    │       ├─ フォルダが存在する？
    │       │   ├─ ✅ YES → 既存フォルダを使用
    │       │   └─ ❌ NO  → 🆕 新規フォルダを自動作成
    │       ↓
    │   [学籍番号フォルダにファイルを移動]
    │       └─ ✅ 移動完了
    │
    └─ ❌ NO (学籍番号なし)
        ↓
        [処理対象外フォルダを取得または作成]
            ├─ 親フォルダ内を検索
            ├─ フォルダが存在する？
            │   ├─ ✅ YES → 既存フォルダを使用
            │   └─ ❌ NO  → 🆕 「処理対象外（学籍番号なし）」フォルダを自動作成
            ↓
        [処理対象外フォルダにファイルを移動]
            └─ ✅ 移動完了
```

---

## 🔧 2つの自動作成機能

### 1️⃣ 学籍番号フォルダの自動作成

**条件**: カレンダーに学籍番号が**ある**が、フォルダが**存在しない**

**コード**:
```javascript
function getOrCreateStudentFolder(studentId) {
  try {
    const parentFolder = DriveApp.getFolderById(STUDENT_FOLDERS_PARENT_ID);
    
    // 既存のフォルダを検索
    const folders = parentFolder.getFoldersByName(studentId);
    if (folders.hasNext()) {
      return folders.next();  // ✅ 既存フォルダを返す
    }
    
    // フォルダが存在しない場合は作成
    console.log(`  📁 フォルダ作成: ${studentId}`);
    return parentFolder.createFolder(studentId);  // 🆕 新規作成
    
  } catch (error) {
    console.error(`❌ 学籍番号フォルダの取得/作成でエラー: ${studentId}`, error);
    throw error;
  }
}
```

**実行例**:
```
[1] 処理中: Gemini Generated Summary for...
  作成日時: 2025/12/29 15:30:00
  カレンダー検索: 15:00:00 ～ 16:00:00
  イベント数: 1件
    - イベント: トークメモ
      ✓ 学籍番号発見: OLTS240501-XX
  ✓ 学籍番号: OLTS240501-XX
  📁 フォルダ作成: OLTS240501-XX  ← 新規フォルダを作成
  ✓ 移動完了: OLTS240501-XX
```

---

### 2️⃣ 処理対象外フォルダの自動作成

**条件**: カレンダーに学籍番号が**ない**

**コード**:
```javascript
function getUnprocessableFolder() {
  try {
    // 設定でフォルダIDが指定されている場合
    if (UNPROCESSABLE_FOLDER_ID) {
      return DriveApp.getFolderById(UNPROCESSABLE_FOLDER_ID);
    }
    
    // 親フォルダ内に「処理対象外」フォルダを検索または作成
    const parentFolder = DriveApp.getFolderById(STUDENT_FOLDERS_PARENT_ID);
    const folderName = '処理対象外（学籍番号なし）';
    
    const folders = parentFolder.getFoldersByName(folderName);
    if (folders.hasNext()) {
      return folders.next();  // ✅ 既存フォルダを返す
    }
    
    console.log(`📁 処理対象外フォルダを作成: ${folderName}`);
    return parentFolder.createFolder(folderName);  // 🆕 新規作成
    
  } catch (error) {
    console.error('❌ 処理対象外フォルダの取得/作成でエラー:', error);
    throw error;
  }
}
```

**実行例**:
```
[2] 処理中: Gemini Generated Summary for...
  作成日時: 2025/12/29 16:00:00
  カレンダー検索: 15:30:00 ～ 16:30:00
  イベント数: 0件
  学籍番号が見つかりませんでした
  ❌ 学籍番号が見つかりません
  → 処理対象外フォルダに移動します
  📁 処理対象外フォルダを作成: 処理対象外（学籍番号なし）  ← 新規フォルダを作成
  ✓ 移動完了: 処理対象外（学籍番号なし）
```

---

## 📂 フォルダ構造の例

### 初回実行前

```
学籍番号フォルダ親 (18YfaP1CrW5Lq_sAeVAR56tIRZR3GwMDS)
├── OLTS240488-AR/  ← 既存フォルダ
│   └── (空)
└── (処理対象外フォルダはまだ存在しない)
```

### 初回実行後

```
学籍番号フォルダ親 (18YfaP1CrW5Lq_sAeVAR56tIRZR3GwMDS)
├── OLTS240488-AR/                      ← 既存フォルダ
│   ├── Gemini メモ1.gdoc              (学籍番号あり・既存フォルダ)
│   └── Gemini メモ2.gdoc
├── OLTS240501-XX/                      ← 🆕 自動作成された学籍番号フォルダ
│   └── Gemini メモ3.gdoc              (学籍番号あり・新規フォルダ作成)
├── OLTS240502-YY/                      ← 🆕 自動作成された学籍番号フォルダ
│   └── Gemini メモ4.gdoc              (学籍番号あり・新規フォルダ作成)
└── 処理対象外（学籍番号なし）/         ← 🆕 自動作成された処理対象外フォルダ
    ├── Gemini メモ5.gdoc              (学籍番号なし)
    └── Gemini メモ6.gdoc              (学籍番号なし)
```

---

## 🧪 動作確認テスト

### テストケース1: 既存の学籍番号フォルダに移動

**状況**:
- カレンダーに学籍番号 `OLTS240488-AR` がある
- フォルダ `OLTS240488-AR` が既に存在する

**期待される動作**:
```
✓ 学籍番号: OLTS240488-AR
✓ 移動完了: OLTS240488-AR
```

**結果**: ✅ 既存フォルダに移動（新規作成なし）

---

### テストケース2: 新規学籍番号フォルダを作成して移動

**状況**:
- カレンダーに学籍番号 `OLTS240501-XX` がある
- フォルダ `OLTS240501-XX` がまだ存在しない

**期待される動作**:
```
✓ 学籍番号: OLTS240501-XX
📁 フォルダ作成: OLTS240501-XX
✓ 移動完了: OLTS240501-XX
```

**結果**: ✅ 新規フォルダを自動作成して移動

---

### テストケース3: 学籍番号がなく処理対象外に移動

**状況**:
- カレンダーに学籍番号がない
- 処理対象外フォルダがまだ存在しない（初回）

**期待される動作**:
```
❌ 学籍番号が見つかりません
→ 処理対象外フォルダに移動します
📁 処理対象外フォルダを作成: 処理対象外（学籍番号なし）
✓ 移動完了: 処理対象外（学籍番号なし）
```

**結果**: ✅ 処理対象外フォルダを自動作成して移動

---

### テストケース4: 学籍番号がなく既存の処理対象外フォルダに移動

**状況**:
- カレンダーに学籍番号がない
- 処理対象外フォルダが既に存在する（2回目以降）

**期待される動作**:
```
❌ 学籍番号が見つかりません
→ 処理対象外フォルダに移動します
✓ 移動完了: 処理対象外（学籍番号なし）
```

**結果**: ✅ 既存の処理対象外フォルダに移動（新規作成なし）

---

## ✅ まとめ

修正版のコードには、以下の**2つの自動作成機能が両方とも含まれています**：

1. ✅ **学籍番号フォルダの自動作成**
   - カレンダーに学籍番号があるが、フォルダがない場合
   - `getOrCreateStudentFolder(studentId)` 関数で実装

2. ✅ **処理対象外フォルダの自動作成**
   - カレンダーに学籍番号がない場合
   - `getUnprocessableFolder()` 関数で実装

**動作保証**:
- 既存フォルダがある場合は、そのフォルダを使用（新規作成なし）
- 既存フォルダがない場合は、自動的に新規作成
- すべてのケースで正常にファイルが移動される

---

**作成日**: 2025-12-29  
**ファイル**: `/home/user/webapp/gas/AutoMoveMemos_Fixed.gs`
