# 週次アナリティクス スプレッドシート連携 セットアップ手順

## 概要
週次のYouTubeアナリティクスデータ取得時に、Googleスプレッドシートへも自動書き込みする機能です。

## 1. スプレッドシートの作成

### 手順
1. Google Sheetsで新しいスプレッドシートを作成
   - 名前例: `VTuberスクール 週次アナリティクス`

2. スプレッドシートのIDをコピー
   - URL: `https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/edit`
   - `{SPREADSHEET_ID}` の部分をコピー

3. サービスアカウントに共有権限を付与
   - スプレッドシートの「共有」ボタンをクリック
   - サービスアカウントのメールアドレスを追加（編集権限）
   - メールアドレス: `GOOGLE_SERVICE_ACCOUNT` の `client_email` フィールド

## 2. 環境変数の設定

Renderの環境変数に以下を追加：

```
WEEKLY_ANALYTICS_SPREADSHEET_ID=<作成したスプレッドシートのID>
```

## 3. スプレッドシートの構造

### 所属生一覧シート
自動的に作成されます。

| A列 | B列 | C列以降 |
|-----|-----|---------|
| 名前 | 学籍番号 | 週次データ（2026-02-03~2026-02-09など） |
| 岡本恵里奈 | OLST230013-OS | Views: 1000 \| Likes: 50 \| Subs: 10 |

- **C列以降のヘッダー**: 週のラベル（例: `2026-02-03~2026-02-09`）
- **データ形式**: `Views: {総視聴回数} | Likes: {総高評価数} | Subs: {純登録者数}`
- **更新方式**: 毎週最新データで上書き

### 個人データシート（チャンネル名）
各生徒ごとにチャンネル名のシートが自動作成されます。

| A列 | B列 | C列 | D列 | ... |
|-----|-----|-----|-----|-----|
| データ項目 | 2026-02-03~2026-02-09 | 2026-02-10~2026-02-16 | 2026-02-17~2026-02-23 | ... |
| 総視聴回数 | 1000 | 1200 | 1500 | ... |
| 総視聴時間（分） | 500 | 600 | 700 | ... |
| ... | ... | ... | ... | ... |

- **A列**: データ項目名（固定）
- **B列以降**: 週次データ（時系列で追加）
- **更新方式**: 新しい週のデータを右側に追加

### データ項目（全33項目）

#### Overall（全体）
1. 総視聴回数
2. 総視聴時間（分）
3. 総高評価数
4. 純登録者数

#### Shorts（各9項目）
5. Shorts: 視聴回数
6. Shorts: 高評価
7. Shorts: コメント
8. Shorts: シェア
9. Shorts: 視聴時間（分）
10. Shorts: 平均視聴時間（秒）
11. Shorts: 平均視聴率（%）
12. Shorts: 登録者増加
13. Shorts: 登録者減少

#### 通常動画（各9項目）
14. 通常動画: 視聴回数
15. 通常動画: 高評価
16. 通常動画: コメント
17. 通常動画: シェア
18. 通常動画: 視聴時間（分）
19. 通常動画: 平均視聴時間（秒）
20. 通常動画: 平均視聴率（%）
21. 通常動画: 登録者増加
22. 通常動画: 登録者減少

#### ライブ（各9項目）
23. ライブ: 視聴回数
24. ライブ: 高評価
25. ライブ: コメント
26. ライブ: シェア
27. ライブ: 視聴時間（分）
28. ライブ: 平均視聴時間（秒）
29. ライブ: 平均視聴率（%）
30. ライブ: 登録者増加
31. ライブ: 登録者減少

## 4. 動作確認

### 手動実行
```bash
curl -X POST https://your-app.onrender.com/api/analytics/auto-fetch \
  -H "Content-Type: application/json"
```

### 確認項目
1. 「所属生一覧」シートが作成されているか
2. 各チャンネル名のシートが作成されているか
3. データが正しく書き込まれているか
4. 週のラベルが正しいか

## 5. Cron設定（自動実行）

Renderの環境変数で設定（既存）：
```
WEEKLY_ANALYTICS_CRON_SCHEDULE=0 10 * * 3
```

- 毎週水曜日 10:00 (UTC) に実行
- 前週（月曜日～日曜日）のデータを取得してスプレッドシートに書き込み

## 6. トラブルシューティング

### スプレッドシートが更新されない
- 環境変数 `WEEKLY_ANALYTICS_SPREADSHEET_ID` が設定されているか確認
- サービスアカウントに共有権限があるか確認
- Renderログで「Spreadsheet updated」のメッセージを確認

### シートが作成されない
- サービスアカウントに編集権限があるか確認
- スプレッドシートIDが正しいか確認

### データが空
- OAuth認証が完了しているか確認（`/oauth/authorize`）
- YouTube Analyticsデータが取得できているか確認（Renderログ）

## 7. メリット

✅ **データの可視化**: Googleスプレッドシートで直接グラフ作成可能
✅ **時系列分析**: 週ごとのデータ推移を簡単に確認
✅ **データ共有**: スプレッドシートのURLを共有するだけ
✅ **エクスポート**: CSVやExcelへの変換が簡単
✅ **自動更新**: 週次Cronで自動的にデータ追加

## 8. 注意事項

⚠️ **シート名の制限**: チャンネル名に特殊文字（`/`, `\`, `?`, `*`, `[`, `]`）が含まれる場合は `_` に置換されます
⚠️ **最大100文字**: チャンネル名が100文字を超える場合は切り詰められます
⚠️ **API制限**: Google Sheets APIのクォータ制限に注意（通常は問題なし）
