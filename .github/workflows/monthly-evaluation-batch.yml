name: Monthly Auto Evaluation (Batch Processing)

# æ¯Žæœˆ1æ—¥ã®åˆå‰3æ™‚ï¼ˆJST = UTC+9ï¼‰= UTC 18:00 (å‰æ—¥) ã«å®Ÿè¡Œ
on:
  schedule:
    - cron: '0 18 * * *'  # æ¯Žæ—¥ UTC 18:00 = JST 03:00 ã«å®Ÿè¡Œï¼ˆæœˆåˆåˆ¤å®šã¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§è¡Œã†ï¼‰
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½
    inputs:
      month:
        description: 'è©•ä¾¡å¯¾è±¡æœˆ (YYYY-MM)'
        required: false
        type: string

jobs:
  evaluate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if today is the 1st of the month
        id: check_date
        run: |
          DAY=$(date -u +%d)
          echo "Today is day $DAY of the month"
          if [ "$DAY" = "01" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping evaluation - not the 1st of the month"
          fi
      
      # ðŸ”¥ æ–°è¦è¿½åŠ : Renderã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—
      - name: Wake up Render service
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          echo "Waking up Render service..."
          for i in {1..10}; do
            echo "Attempt $i/10: Pinging health endpoint..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://vtuber-school-evaluation.onrender.com/api/health || echo "000")
            echo "Response status: $STATUS"
            
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Service is ready!"
              break
            fi
            
            if [ $i -lt 10 ]; then
              echo "Waiting 10 seconds before retry..."
              sleep 10
            fi
          done
          
          # æœ€çµ‚ç¢ºèª
          FINAL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://vtuber-school-evaluation.onrender.com/api/health || echo "000")
          if [ "$FINAL_STATUS" != "200" ]; then
            echo "::error::Service failed to wake up after 10 attempts"
            exit 1
          fi
          
          echo "Service is fully operational. Waiting 5 more seconds for stability..."
          sleep 5
      
      - name: Get previous month
        if: steps.check_date.outputs.should_run == 'true'
        id: get_month
        run: |
          if [ -n "${{ inputs.month }}" ]; then
            MONTH="${{ inputs.month }}"
          else
            MONTH=$(date -u -d "1 month ago" +%Y-%m)
          fi
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "Evaluating for month: $MONTH"
      
      - name: Get batch info
        if: steps.check_date.outputs.should_run == 'true'
        id: batch_info
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          
          # ãƒãƒƒãƒæƒ…å ±ã‚’å–å¾—
          STATUS=$(curl -s "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate/status")
          echo "Status: $STATUS"
          
          TOTAL_BATCHES=$(echo "$STATUS" | jq -r '.totalBatches')
          echo "total_batches=$TOTAL_BATCHES" >> $GITHUB_OUTPUT
          echo "Total batches to process: $TOTAL_BATCHES"
      
      - name: Process batches
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          TOTAL_BATCHES="${{ steps.batch_info.outputs.total_batches }}"
          
          echo "Starting batch processing for $MONTH"
          echo "Total batches: $TOTAL_BATCHES"
          
          for ((i=0; i<$TOTAL_BATCHES; i++)); do
            echo "============================================"
            echo "Processing batch $((i+1))/$TOTAL_BATCHES"
            echo "============================================"
            
            # ãƒãƒƒãƒè©•ä¾¡ã‚’å®Ÿè¡Œï¼ˆãƒªãƒˆãƒ©ã‚¤ãƒ­ã‚¸ãƒƒã‚¯ä»˜ãï¼‰
            MAX_RETRIES=3
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              if [ $RETRY_COUNT -gt 0 ]; then
                echo "Retry $RETRY_COUNT/$MAX_RETRIES after 30 seconds..."
                sleep 30
              fi
              
              RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -X POST \
                "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate?month=$MONTH&batchIndex=$i&batchSize=300")
              
              HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
              BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
              
              echo "Response Status: $HTTP_STATUS"
              
              if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
                SUCCESS=true
                SUCCESS_COUNT=$(echo "$BODY" | jq -r '.successCount')
                ERROR_COUNT=$(echo "$BODY" | jq -r '.errorCount')
                SKIPPED_COUNT=$(echo "$BODY" | jq -r '.skippedCount')
                echo "âœ… Batch $((i+1)) completed: Success=$SUCCESS_COUNT, Error=$ERROR_COUNT, Skipped=$SKIPPED_COUNT"
              else
                RETRY_COUNT=$((RETRY_COUNT+1))
                echo "::warning::Batch $((i+1)) failed with status $HTTP_STATUS (Attempt $RETRY_COUNT/$MAX_RETRIES)"
              fi
            done
            
            if [ "$SUCCESS" = "false" ]; then
              echo "::error::Batch $((i+1)) failed after $MAX_RETRIES attempts"
              # ã‚¨ãƒ©ãƒ¼ã§ã‚‚ç¶šè¡Œï¼ˆæ¬¡ã®ãƒãƒƒãƒã‚’è©¦è¡Œï¼‰
            fi
            
            # æ¬¡ã®ãƒãƒƒãƒã®å‰ã«15åˆ†å¾…æ©Ÿï¼ˆæœ€å¾Œã®ãƒãƒƒãƒã‚’é™¤ãï¼‰
            if [ $i -lt $((TOTAL_BATCHES-1)) ]; then
              echo "Waiting 15 minutes before next batch..."
              sleep 900  # 15åˆ† = 900ç§’
            fi
          done
          
          echo "============================================"
          echo "All batches completed!"
          echo "============================================"
