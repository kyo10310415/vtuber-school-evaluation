name: Monthly Auto Evaluation (Complete)

on:
  schedule:
    # æ¯Žæœˆ1æ—¥ JST 10:00 (UTC 01:00)
    - cron: '0 1 1 * *'
  workflow_dispatch:
    inputs:
      month:
        description: 'Evaluation month (YYYY-MM, leave empty for previous month)'
        required: false
        type: string

jobs:
  monthly-evaluation:
    runs-on: ubuntu-latest
    timeout-minutes: 240  # 4æ™‚é–“ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
    
    steps:
      - name: Wake up Render service
        run: |
          echo "ðŸ”¥ Waking up Render service..."
          for i in {1..10}; do
            echo "Attempt $i/10: Pinging health endpoint..."
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://vtuber-school-evaluation.onrender.com/api/health || echo "000")
            echo "Response status: $STATUS"
            
            if [ "$STATUS" = "200" ]; then
              echo "âœ… Service is ready!"
              break
            fi
            
            if [ $i -lt 10 ]; then
              echo "Waiting 10 seconds before retry..."
              sleep 10
            fi
          done
          
          FINAL_STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://vtuber-school-evaluation.onrender.com/api/health || echo "000")
          if [ "$FINAL_STATUS" != "200" ]; then
            echo "::error::Service failed to wake up"
            exit 1
          fi
          
          echo "Service ready. Waiting 5 seconds for stability..."
          sleep 5
      
      - name: Get evaluation month
        id: get_month
        run: |
          if [ -n "${{ inputs.month }}" ]; then
            MONTH="${{ inputs.month }}"
          else
            MONTH=$(date -u -d "1 month ago" +%Y-%m)
          fi
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "ðŸ“… Evaluating for month: $MONTH"
      
      # ============================================
      # Part 1: çµ±åˆè©•ä¾¡ï¼ˆãƒ—ãƒ­ãƒ¬ãƒ™ãƒ« + YouTube + Xï¼‰
      # ============================================
      
      - name: Get batch info for integrated evaluation
        id: batch_info
        run: |
          echo "ðŸ“Š Getting batch information..."
          STATUS=$(curl -s "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate/status")
          echo "$STATUS" | jq '.'
          
          TOTAL_BATCHES=$(echo "$STATUS" | jq -r '.totalBatches')
          echo "total_batches=$TOTAL_BATCHES" >> $GITHUB_OUTPUT
          echo "Total batches for integrated evaluation: $TOTAL_BATCHES"
      
      - name: Process integrated evaluation batches
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          TOTAL_BATCHES="${{ steps.batch_info.outputs.total_batches }}"
          
          echo "ðŸš€ Starting integrated evaluation for $MONTH"
          echo "Total batches: $TOTAL_BATCHES"
          
          for ((i=0; i<$TOTAL_BATCHES; i++)); do
            echo "============================================"
            echo "ðŸ“¦ Processing Batch $((i+1))/$TOTAL_BATCHES (Integrated Evaluation)"
            echo "============================================"
            
            MAX_RETRIES=3
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              if [ $RETRY_COUNT -gt 0 ]; then
                echo "â³ Retry $RETRY_COUNT/$MAX_RETRIES after 30 seconds..."
                sleep 30
              fi
              
              RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -X POST \
                "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate?month=$MONTH&batchIndex=$i&batchSize=300")
              
              HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
              BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
              
              echo "Response Status: $HTTP_STATUS"
              
              if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
                SUCCESS=true
                SUCCESS_COUNT=$(echo "$BODY" | jq -r '.successCount')
                ERROR_COUNT=$(echo "$BODY" | jq -r '.errorCount')
                SKIPPED_COUNT=$(echo "$BODY" | jq -r '.skippedCount')
                echo "âœ… Batch $((i+1)) completed: Success=$SUCCESS_COUNT, Error=$ERROR_COUNT, Skipped=$SKIPPED_COUNT"
              else
                RETRY_COUNT=$((RETRY_COUNT+1))
                echo "::warning::Batch $((i+1)) failed with status $HTTP_STATUS (Attempt $RETRY_COUNT/$MAX_RETRIES)"
              fi
            done
            
            if [ "$SUCCESS" = "false" ]; then
              echo "::error::Batch $((i+1)) failed after $MAX_RETRIES attempts"
            fi
            
            # æ¬¡ã®ãƒãƒƒãƒã®å‰ã«15åˆ†å¾…æ©Ÿ
            if [ $i -lt $((TOTAL_BATCHES-1)) ]; then
              echo "â³ Waiting 15 minutes before next batch..."
              sleep 900
            fi
          done
          
          echo "âœ… Integrated evaluation completed!"
      
      # ============================================
      # Part 2: Xè©•ä¾¡å°‚ç”¨ãƒãƒƒãƒï¼ˆè¿½åŠ å‡¦ç†ã€30åˆ†é–“éš”ï¼‰
      # ============================================
      
      - name: Reset X evaluation progress for new month
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "ðŸ”„ Resetting X evaluation progress for $MONTH..."
          curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?reset=true&month=$MONTH" | jq '.'
      
      - name: Process X Evaluation Batch 0
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "ðŸ”„ Processing X Evaluation Batch 0..."
          RESPONSE=$(curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?month=$MONTH")
          echo "$RESPONSE" | jq '.'
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "::warning::X Batch 0 failed"
          else
            COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
            TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
            echo "âœ… X Batch 0 completed: $COMPLETED/$TOTAL students"
          fi
      
      - name: Wait 30 minutes
        run: |
          echo "â³ Waiting 30 minutes before next X batch..."
          sleep 1800
      
      - name: Process X Evaluation Batch 1
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "ðŸ”„ Processing X Evaluation Batch 1..."
          RESPONSE=$(curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?month=$MONTH")
          echo "$RESPONSE" | jq '.'
          
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "ðŸŽ‰ All X evaluations completed!"
            exit 0
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          echo "âœ… X Batch 1 completed: $COMPLETED/$TOTAL students"
      
      - name: Wait 30 minutes
        run: |
          echo "â³ Waiting 30 minutes before next X batch..."
          sleep 1800
      
      - name: Process X Evaluation Batch 2
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "ðŸ”„ Processing X Evaluation Batch 2..."
          RESPONSE=$(curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?month=$MONTH")
          echo "$RESPONSE" | jq '.'
          
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "ðŸŽ‰ All X evaluations completed!"
            exit 0
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          echo "âœ… X Batch 2 completed: $COMPLETED/$TOTAL students"
      
      - name: Wait 30 minutes
        run: |
          echo "â³ Waiting 30 minutes before next X batch..."
          sleep 1800
      
      - name: Process X Evaluation Batch 3
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "ðŸ”„ Processing X Evaluation Batch 3..."
          RESPONSE=$(curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?month=$MONTH")
          echo "$RESPONSE" | jq '.'
          
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "ðŸŽ‰ All X evaluations completed!"
            exit 0
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          echo "âœ… X Batch 3 completed: $COMPLETED/$TOTAL students"
      
      - name: Wait 30 minutes
        run: |
          echo "â³ Waiting 30 minutes before next X batch..."
          sleep 1800
      
      - name: Process X Evaluation Batch 4
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "ðŸ”„ Processing X Evaluation Batch 4..."
          RESPONSE=$(curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?month=$MONTH")
          echo "$RESPONSE" | jq '.'
          
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "ðŸŽ‰ All X evaluations completed!"
            exit 0
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          echo "âœ… X Batch 4 completed: $COMPLETED/$TOTAL students"
      
      - name: Wait 30 minutes
        run: |
          echo "â³ Waiting 30 minutes before next X batch..."
          sleep 1800
      
      - name: Process X Evaluation Batch 5 (Final)
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "ðŸ”„ Processing X Evaluation Batch 5 (Final)..."
          RESPONSE=$(curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?month=$MONTH")
          echo "$RESPONSE" | jq '.'
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          echo "âœ… X Batch 5 completed: $COMPLETED/$TOTAL students"
          echo "ðŸŽ‰ All evaluations completed successfully!"
      
      - name: Summary
        if: always()
        run: |
          echo "============================================"
          echo "ðŸ“Š Monthly Evaluation Summary"
          echo "============================================"
          echo "Date: $(date)"
          echo "Month: ${{ steps.get_month.outputs.month }}"
          echo "Status: Completed"
          echo "============================================"
