name: Monthly Auto Evaluation

# 毎月1日の午前3時（JST = UTC+9）= UTC 18:00 (前日) に実行
on:
  schedule:
    - cron: '0 18 * * 0-6'  # 毎日 UTC 18:00 = JST 03:00 に実行（月初判定はスクリプト内で行う）
  workflow_dispatch:  # 手動実行も可能

jobs:
  evaluate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if today is the 1st of the month
        id: check_date
        run: |
          DAY=$(date -u +%d)
          echo "Today is day $DAY of the month"
          if [ "$DAY" = "01" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping evaluation - not the 1st of the month"
          fi
      
      - name: Get previous month
        if: steps.check_date.outputs.should_run == 'true'
        id: get_month
        run: |
          # 前月を YYYY-MM 形式で取得
          PREVIOUS_MONTH=$(date -u -d "1 month ago" +%Y-%m)
          echo "month=$PREVIOUS_MONTH" >> $GITHUB_OUTPUT
          echo "Evaluating for month: $PREVIOUS_MONTH"
      
      - name: Trigger auto evaluation
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "Triggering evaluation for $MONTH"
          
          # 自動評価エンドポイントを呼び出す
          RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
            -X POST \
            "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate?month=$MONTH")
          
          HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
          BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
          
          echo "Response Status: $HTTP_STATUS"
          echo "Response Body: $BODY"
          
          if [ "$HTTP_STATUS" -ge 400 ]; then
            echo "::error::Evaluation failed with status $HTTP_STATUS"
            exit 1
          fi
          
          echo "Evaluation completed successfully"
