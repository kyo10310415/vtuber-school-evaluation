name: Monthly Auto Evaluation (Batch Processing)

# 毎月1日の午前3時（JST = UTC+9）= UTC 18:00 (前日) に実行
on:
  schedule:
    - cron: '0 18 * * *'  # 毎日 UTC 18:00 = JST 03:00 に実行（月初判定はスクリプト内で行う）
  workflow_dispatch:  # 手動実行も可能
    inputs:
      month:
        description: '評価対象月 (YYYY-MM)'
        required: false
        type: string

jobs:
  evaluate:
    runs-on: ubuntu-latest
    
    steps:
      - name: Check if today is the 1st of the month
        id: check_date
        run: |
          DAY=$(date -u +%d)
          echo "Today is day $DAY of the month"
          if [ "$DAY" = "01" ] || [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "Skipping evaluation - not the 1st of the month"
          fi
      
      - name: Get previous month
        if: steps.check_date.outputs.should_run == 'true'
        id: get_month
        run: |
          if [ -n "${{ inputs.month }}" ]; then
            MONTH="${{ inputs.month }}"
          else
            MONTH=$(date -u -d "1 month ago" +%Y-%m)
          fi
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "Evaluating for month: $MONTH"
      
      - name: Get batch info
        if: steps.check_date.outputs.should_run == 'true'
        id: batch_info
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          
          # バッチ情報を取得
          STATUS=$(curl -s "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate/status")
          echo "Status: $STATUS"
          
          TOTAL_BATCHES=$(echo "$STATUS" | jq -r '.totalBatches')
          echo "total_batches=$TOTAL_BATCHES" >> $GITHUB_OUTPUT
          echo "Total batches to process: $TOTAL_BATCHES"
      
      - name: Process batches
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          TOTAL_BATCHES="${{ steps.batch_info.outputs.total_batches }}"
          
          echo "Starting batch processing for $MONTH"
          echo "Total batches: $TOTAL_BATCHES"
          
          for ((i=0; i<$TOTAL_BATCHES; i++)); do
            echo "============================================"
            echo "Processing batch $((i+1))/$TOTAL_BATCHES"
            echo "============================================"
            
            # バッチ評価を実行
            RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
              -X POST \
              "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate?month=$MONTH&batchIndex=$i&batchSize=300")
            
            HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
            BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
            
            echo "Response Status: $HTTP_STATUS"
            echo "Response Body: $BODY"
            
            if [ "$HTTP_STATUS" -ge 400 ]; then
              echo "::warning::Batch $((i+1)) failed with status $HTTP_STATUS"
              echo "Response: $BODY"
              # エラーでも続行（次のバッチを試行）
            else
              SUCCESS_COUNT=$(echo "$BODY" | jq -r '.successCount')
              ERROR_COUNT=$(echo "$BODY" | jq -r '.errorCount')
              SKIPPED_COUNT=$(echo "$BODY" | jq -r '.skippedCount')
              echo "✅ Batch $((i+1)) completed: Success=$SUCCESS_COUNT, Error=$ERROR_COUNT, Skipped=$SKIPPED_COUNT"
            fi
            
            # 次のバッチの前に15分待機（最後のバッチを除く）
            if [ $i -lt $((TOTAL_BATCHES-1)) ]; then
              echo "Waiting 15 minutes before next batch..."
              sleep 900  # 15分 = 900秒
            fi
          done
          
          echo "============================================"
          echo "All batches completed!"
          echo "============================================"
