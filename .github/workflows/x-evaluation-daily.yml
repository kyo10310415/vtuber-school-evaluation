name: Daily X Evaluation (Multiple Batches)

on:
  schedule:
    # ÊØéÊó• JST 10:00 (UTC 01:00)
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      month:
        description: 'Evaluation month (YYYY-MM, leave empty for previous month)'
        required: false
        type: string

jobs:
  x-evaluation:
    runs-on: ubuntu-latest
    timeout-minutes: 180  # 3ÊôÇÈñì„Çø„Ç§„É†„Ç¢„Ç¶„Éà
    
    steps:
      - name: Check if evaluation is already completed
        id: check_completion
        run: |
          echo "Checking if evaluation is already completed..."
          RESPONSE=$(curl -s -X POST https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only)
          echo "Response: $RESPONSE"
          
          # isCompleted„Ååtrue„ÅÆÂ†¥Âêà„ÅØ„Çπ„Ç≠„ÉÉ„Éó
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted // false')
          
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "‚úÖ Evaluation already completed. Skipping."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "üöÄ Evaluation not completed. Starting batches."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Process Batch 0
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "üîÑ Processing Batch 0..."
          RESPONSE=$(curl -s -X POST https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only)
          echo "$RESPONSE" | jq '.'
          
          # „Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Batch 0 failed"
            exit 1
          fi
          
          # ÈÄ≤ÊçóÁ¢∫Ë™ç
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          
          echo "‚úÖ Batch 0 completed: $COMPLETED/$TOTAL students"
          
          # „Åô„Åπ„Å¶ÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØÊ¨°„ÅÆ„Éê„ÉÉ„ÉÅ„Çí„Çπ„Ç≠„ÉÉ„Éó
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "üéâ All students evaluated! Stopping."
            exit 0
          fi
      
      - name: Wait 30 minutes
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "‚è≥ Waiting 30 minutes before next batch..."
          sleep 1800
      
      - name: Process Batch 1
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "üîÑ Processing Batch 1..."
          RESPONSE=$(curl -s -X POST https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only)
          echo "$RESPONSE" | jq '.'
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Batch 1 failed"
            exit 1
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          
          echo "‚úÖ Batch 1 completed: $COMPLETED/$TOTAL students"
          
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "üéâ All students evaluated! Stopping."
            exit 0
          fi
      
      - name: Wait 30 minutes
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "‚è≥ Waiting 30 minutes before next batch..."
          sleep 1800
      
      - name: Process Batch 2
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "üîÑ Processing Batch 2..."
          RESPONSE=$(curl -s -X POST https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only)
          echo "$RESPONSE" | jq '.'
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Batch 2 failed"
            exit 1
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          
          echo "‚úÖ Batch 2 completed: $COMPLETED/$TOTAL students"
          
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "üéâ All students evaluated! Stopping."
            exit 0
          fi
      
      - name: Wait 30 minutes
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "‚è≥ Waiting 30 minutes before next batch..."
          sleep 1800
      
      - name: Process Batch 3
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "üîÑ Processing Batch 3..."
          RESPONSE=$(curl -s -X POST https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only)
          echo "$RESPONSE" | jq '.'
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Batch 3 failed"
            exit 1
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          
          echo "‚úÖ Batch 3 completed: $COMPLETED/$TOTAL students"
          
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "üéâ All students evaluated! Stopping."
            exit 0
          fi
      
      - name: Wait 30 minutes
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "‚è≥ Waiting 30 minutes before next batch..."
          sleep 1800
      
      - name: Process Batch 4
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "üîÑ Processing Batch 4..."
          RESPONSE=$(curl -s -X POST https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only)
          echo "$RESPONSE" | jq '.'
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Batch 4 failed"
            exit 1
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          
          echo "‚úÖ Batch 4 completed: $COMPLETED/$TOTAL students"
          
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "üéâ All students evaluated! Stopping."
            exit 0
          fi
      
      - name: Wait 30 minutes
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "‚è≥ Waiting 30 minutes before next batch..."
          sleep 1800
      
      - name: Process Batch 5 (Final)
        if: steps.check_completion.outputs.should_run == 'true'
        run: |
          echo "üîÑ Processing Batch 5 (Final)..."
          RESPONSE=$(curl -s -X POST https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only)
          echo "$RESPONSE" | jq '.'
          
          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')
          if [ "$SUCCESS" != "true" ]; then
            echo "‚ùå Batch 5 failed"
            exit 1
          fi
          
          COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
          TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
          IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
          
          echo "‚úÖ Batch 5 completed: $COMPLETED/$TOTAL students"
          
          if [ "$IS_COMPLETED" = "true" ]; then
            echo "üéâ All students evaluated successfully!"
          else
            echo "‚ö†Ô∏è Some students remaining, will continue tomorrow"
          fi
      
      - name: Summary
        if: always()
        run: |
          echo "üìä X Evaluation Summary"
          echo "======================="
          echo "Date: $(date)"
          echo "Status: Completed"
