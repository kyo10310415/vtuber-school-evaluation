name: Daily Evaluation (ProLevel + YouTube + X)

on:
  schedule:
    # ÊØéÊó• JST 10:00 (UTC 01:00) - ÊúàÂàù„Åã„Çâ9Êó•ÈñìÂÆüË°å
    - cron: '0 1 * * *'
  workflow_dispatch:
    inputs:
      month:
        description: 'Evaluation month (YYYY-MM, leave empty for previous month)'
        required: false
        type: string
      day:
        description: 'Day number (1-9, leave empty for auto-detect)'
        required: false
        type: string

jobs:
  daily-evaluation:
    runs-on: ubuntu-latest
    timeout-minutes: 120  # 2ÊôÇÈñì„Çø„Ç§„É†„Ç¢„Ç¶„Éà
    
    steps:
      - name: Check if within first 9 days of month
        id: check_date
        run: |
          DAY_OF_MONTH=$(date +%d | sed 's/^0//')
          echo "day=$DAY_OF_MONTH" >> $GITHUB_OUTPUT
          
          if [ -n "${{ inputs.day }}" ]; then
            DAY_OF_MONTH="${{ inputs.day }}"
            echo "Using manual day: $DAY_OF_MONTH"
          fi
          
          if [ $DAY_OF_MONTH -le 9 ]; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Within first 9 days of month, will run evaluation"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Beyond day 9, skipping evaluation"
          fi
      
      - name: Wake up Render service
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          echo "üî• Waking up Render service..."
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://vtuber-school-evaluation.onrender.com/api/health || echo "000")
            echo "Attempt $i/10: Status $STATUS"
            
            if [ "$STATUS" = "200" ]; then
              echo "‚úÖ Service is ready!"
              break
            fi
            
            if [ $i -lt 10 ]; then
              sleep 10
            fi
          done
          
          sleep 5
      
      - name: Get evaluation month
        if: steps.check_date.outputs.should_run == 'true'
        id: get_month
        run: |
          if [ -n "${{ inputs.month }}" ]; then
            MONTH="${{ inputs.month }}"
          else
            MONTH=$(date -u -d "1 month ago" +%Y-%m)
          fi
          echo "month=$MONTH" >> $GITHUB_OUTPUT
          echo "üìÖ Evaluating for month: $MONTH"
      
      - name: Calculate batch range for today
        if: steps.check_date.outputs.should_run == 'true'
        id: batch_range
        run: |
          DAY="${{ steps.check_date.outputs.day }}"
          BATCHES_PER_DAY=16  # 1Êó•„ÅÇ„Åü„Çä16„Éê„ÉÉ„ÉÅÔºà80‰∫∫Ôºâ
          
          # YouTubeË©ï‰æ°„ÅØ2Êó•„ÅßÂÆå‰∫ÜÔºà154‰∫∫ √∑ 80 = 2Êó•Ôºâ
          # Day 1: batch 0-15 (80‰∫∫)
          # Day 2: batch 16-30 (75‰∫∫) - YouTubeÂÆå‰∫Ü
          # Day 3-9: „Éó„É≠„É¨„Éô„É´„ÅÆ„Åø
          
          START_BATCH=$(( (DAY - 1) * BATCHES_PER_DAY ))
          END_BATCH=$(( START_BATCH + BATCHES_PER_DAY - 1 ))
          
          # YouTube„ÅØ31„Éê„ÉÉ„ÉÅ„ÅßÂÆå‰∫ÜÔºà154‰∫∫Ôºâ
          YOUTUBE_TOTAL_BATCHES=31
          
          if [ $END_BATCH -ge $YOUTUBE_TOTAL_BATCHES ]; then
            END_BATCH=$(( YOUTUBE_TOTAL_BATCHES - 1 ))
            echo "youtube_completed=true" >> $GITHUB_OUTPUT
            echo "üéâ YouTube evaluation will be completed today (batch $START_BATCH-$END_BATCH)"
          else
            echo "youtube_completed=false" >> $GITHUB_OUTPUT
          fi
          
          echo "start_batch=$START_BATCH" >> $GITHUB_OUTPUT
          echo "end_batch=$END_BATCH" >> $GITHUB_OUTPUT
          echo "üìä Day $DAY: Processing batches $START_BATCH to $END_BATCH"
      
      # ============================================
      # „Éó„É≠„É¨„Éô„É´ + YouTube Ë©ï‰æ°ÔºàXË©ï‰æ°„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºâ
      # ============================================
      
      - name: Process ProLevel + YouTube evaluation batches
        if: steps.check_date.outputs.should_run == 'true'
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          START_BATCH=${{ steps.batch_range.outputs.start_batch }}
          END_BATCH=${{ steps.batch_range.outputs.end_batch }}
          
          echo "üöÄ Starting ProLevel + YouTube evaluation for $MONTH"
          echo "Processing batches $START_BATCH to $END_BATCH (16 batches, 83 students)"
          
          for ((i=START_BATCH; i<=END_BATCH; i++)); do
            echo "============================================"
            echo "üì¶ Processing Batch $i (Day ${{ steps.check_date.outputs.day }})"
            echo "============================================"
            
            MAX_RETRIES=3
            RETRY_COUNT=0
            SUCCESS=false
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
              if [ $RETRY_COUNT -gt 0 ]; then
                echo "‚è≥ Retry $RETRY_COUNT/$MAX_RETRIES after 30 seconds..."
                sleep 30
              fi
              
              # skipX=true „ÅßXË©ï‰æ°„Çí„Çπ„Ç≠„ÉÉ„ÉóÔºà„Éê„ÉÉ„ÉÅ„Çµ„Ç§„Ç∫5Ôºâ
              RESPONSE=$(curl -s -w "\nHTTP_STATUS:%{http_code}" \
                -X POST \
                "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate?month=$MONTH&batchIndex=$i&batchSize=5&skipX=true")
              
              HTTP_STATUS=$(echo "$RESPONSE" | grep "HTTP_STATUS" | cut -d: -f2)
              BODY=$(echo "$RESPONSE" | sed '/HTTP_STATUS/d')
              
              echo "Response Status: $HTTP_STATUS"
              
              if [ "$HTTP_STATUS" -ge 200 ] && [ "$HTTP_STATUS" -lt 400 ]; then
                SUCCESS=true
                SUCCESS_COUNT=$(echo "$BODY" | jq -r '.successCount')
                ERROR_COUNT=$(echo "$BODY" | jq -r '.errorCount')
                SKIPPED_COUNT=$(echo "$BODY" | jq -r '.skippedCount')
                echo "‚úÖ Batch $i completed: Success=$SUCCESS_COUNT, Error=$ERROR_COUNT, Skipped=$SKIPPED_COUNT"
              else
                RETRY_COUNT=$((RETRY_COUNT+1))
                echo "::warning::Batch $i failed with status $HTTP_STATUS (Attempt $RETRY_COUNT/$MAX_RETRIES)"
              fi
            done
            
            if [ "$SUCCESS" = "false" ]; then
              echo "::error::Batch $i failed after $MAX_RETRIES attempts"
            fi
            
            # Ê¨°„ÅÆ„Éê„ÉÉ„ÉÅ„ÅÆÂâç„Å´Â∞ë„ÅóÂæÖÊ©üÔºàYouTube API„É¨„Éº„ÉàÂà∂ÈôêÂØæÁ≠ñÔºâ
            if [ $i -lt $END_BATCH ]; then
              echo "‚è≥ Waiting 10 seconds before next batch..."
              sleep 10
            fi
          done
          
          echo "‚úÖ ProLevel + YouTube evaluation completed for Day ${{ steps.check_date.outputs.day }}!"
      
      # ============================================
      # XË©ï‰æ°ÔºàDay 1„ÅÆ„ÅøÂÆüË°åÔºâ
      # ============================================
      
      - name: Check if Day 1 for X evaluation
        if: steps.check_date.outputs.should_run == 'true'
        id: check_day1
        run: |
          DAY="${{ steps.check_date.outputs.day }}"
          if [ "$DAY" = "1" ]; then
            echo "is_day1=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Day 1: Will run X evaluation"
          else
            echo "is_day1=false" >> $GITHUB_OUTPUT
            echo "‚è≠Ô∏è Not Day 1: Skipping X evaluation"
          fi
      
      - name: Reset X evaluation progress
        if: steps.check_day1.outputs.is_day1 == 'true'
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "üîÑ Resetting X evaluation progress for $MONTH..."
          curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?reset=true&month=$MONTH" | jq '.'
      
      - name: Process X Evaluation Batches
        if: steps.check_day1.outputs.is_day1 == 'true'
        run: |
          MONTH="${{ steps.get_month.outputs.month }}"
          echo "üîÑ Processing X Evaluation..."
          
          for BATCH_NUM in {0..5}; do
            echo "============================================"
            echo "üì¶ Processing X Batch $BATCH_NUM"
            echo "============================================"
            
            RESPONSE=$(curl -s -X POST "https://vtuber-school-evaluation.onrender.com/api/auto-evaluate-x-only?month=$MONTH")
            echo "$RESPONSE" | jq '.'
            
            IS_COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.isCompleted')
            if [ "$IS_COMPLETED" = "true" ]; then
              echo "üéâ All X evaluations completed!"
              break
            fi
            
            COMPLETED=$(echo "$RESPONSE" | jq -r '.progress.completedStudents')
            TOTAL=$(echo "$RESPONSE" | jq -r '.progress.totalStudents')
            echo "‚úÖ X Batch $BATCH_NUM completed: $COMPLETED/$TOTAL students"
            
            # Ê¨°„ÅÆ„Éê„ÉÉ„ÉÅ„ÅÆÂâç„Å´30ÂàÜÂæÖÊ©ü
            if [ $BATCH_NUM -lt 5 ]; then
              echo "‚è≥ Waiting 30 minutes before next X batch..."
              sleep 1800
            fi
          done
      
      - name: Summary
        if: always()
        run: |
          echo "============================================"
          echo "üìä Daily Evaluation Summary"
          echo "============================================"
          echo "Date: $(date)"
          echo "Day: ${{ steps.check_date.outputs.day }}"
          echo "Month: ${{ steps.get_month.outputs.month }}"
          echo "Batches: ${{ steps.batch_range.outputs.start_batch }} - ${{ steps.batch_range.outputs.end_batch }}"
          echo "Status: Completed"
          echo "============================================"
