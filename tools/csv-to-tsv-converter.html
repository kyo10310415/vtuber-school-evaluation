<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion CSV → TSV 変換ツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-lg shadow-lg p-8">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-file-csv mr-2"></i>
                Notion CSV → TSV 変換ツール
            </h1>
            
            <p class="text-gray-600 mb-6">
                NotionからエクスポートしたCSVファイルを、Google Apps Script用のTSVデータに変換します。
            </p>

            <!-- ファイル選択 -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    NotionのCSVファイルを選択
                </label>
                <input 
                    type="file" 
                    id="csvFile" 
                    accept=".csv"
                    class="block w-full text-sm text-gray-500
                           file:mr-4 file:py-2 file:px-4
                           file:rounded-lg file:border-0
                           file:text-sm file:font-semibold
                           file:bg-purple-50 file:text-purple-700
                           hover:file:bg-purple-100 cursor-pointer"
                >
            </div>

            <!-- 変換ボタン -->
            <button 
                id="convertBtn"
                class="w-full bg-purple-600 text-white font-bold py-3 px-6 rounded-lg
                       hover:bg-purple-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
            >
                変換する
            </button>

            <!-- 結果表示 -->
            <div id="result" class="mt-6 hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h2 class="text-lg font-bold text-green-800 mb-2">
                        <i class="fas fa-check-circle mr-2"></i>
                        変換完了
                    </h2>
                    <p class="text-green-700">
                        <span id="recordCount"></span>件のデータを変換しました。
                    </p>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        変換結果（Google Apps Scriptに貼り付けてください）
                    </label>
                    <textarea 
                        id="tsvOutput" 
                        rows="15"
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg font-mono text-xs"
                        readonly
                    ></textarea>
                </div>

                <div class="flex gap-4">
                    <button 
                        id="copyBtn"
                        class="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg
                               hover:bg-blue-700 transition"
                    >
                        <i class="fas fa-copy mr-2"></i>
                        クリップボードにコピー
                    </button>
                    
                    <button 
                        id="downloadBtn"
                        class="flex-1 bg-gray-600 text-white font-bold py-2 px-4 rounded-lg
                               hover:bg-gray-700 transition"
                    >
                        <i class="fas fa-download mr-2"></i>
                        TSVファイルをダウンロード
                    </button>
                </div>
            </div>

            <!-- エラー表示 -->
            <div id="error" class="mt-6 hidden">
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <h2 class="text-lg font-bold text-red-800 mb-2">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        エラー
                    </h2>
                    <p id="errorMessage" class="text-red-700"></p>
                </div>
            </div>
        </div>

        <!-- 使い方 -->
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mt-6">
            <h2 class="text-xl font-bold text-blue-800 mb-4">
                <i class="fas fa-info-circle mr-2"></i>
                使い方
            </h2>
            <ol class="list-decimal list-inside space-y-2 text-blue-700">
                <li>NotionでWannaV Tutors Databaseを開く</li>
                <li>右上の「…」→「エクスポート」→「CSV」を選択してダウンロード</li>
                <li>ダウンロードしたZIPファイルを解凍</li>
                <li>このツールでCSVファイルを選択</li>
                <li>「変換する」をクリック</li>
                <li>「クリップボードにコピー」をクリック</li>
                <li>Google Apps Scriptの <code class="bg-blue-100 px-2 py-1 rounded">DATA</code> 変数に貼り付け</li>
            </ol>
        </div>
    </div>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <script>
        const csvFileInput = document.getElementById('csvFile');
        const convertBtn = document.getElementById('convertBtn');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        const tsvOutput = document.getElementById('tsvOutput');
        const recordCountSpan = document.getElementById('recordCount');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const errorMessage = document.getElementById('errorMessage');

        let convertedTSV = '';

        convertBtn.addEventListener('click', async () => {
            const file = csvFileInput.files[0];
            
            if (!file) {
                showError('CSVファイルを選択してください');
                return;
            }

            try {
                convertBtn.disabled = true;
                convertBtn.textContent = '変換中...';
                
                const text = await file.text();
                const tsv = convertCSVToTSV(text);
                
                convertedTSV = tsv.data;
                tsvOutput.value = convertedTSV;
                recordCountSpan.textContent = tsv.count;
                
                resultDiv.classList.remove('hidden');
                errorDiv.classList.add('hidden');
                
            } catch (error) {
                showError(error.message);
            } finally {
                convertBtn.disabled = false;
                convertBtn.textContent = '変換する';
            }
        });

        copyBtn.addEventListener('click', async () => {
            try {
                await navigator.clipboard.writeText(convertedTSV);
                copyBtn.innerHTML = '<i class="fas fa-check mr-2"></i>コピーしました！';
                copyBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                copyBtn.classList.add('bg-green-600');
                
                setTimeout(() => {
                    copyBtn.innerHTML = '<i class="fas fa-copy mr-2"></i>クリップボードにコピー';
                    copyBtn.classList.remove('bg-green-600');
                    copyBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                }, 2000);
            } catch (error) {
                showError('コピーに失敗しました: ' + error.message);
            }
        });

        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([convertedTSV], { type: 'text/tab-separated-values' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sns_accounts_${new Date().toISOString().split('T')[0]}.tsv`;
            a.click();
            URL.revokeObjectURL(url);
        });

        function convertCSVToTSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];
            
            // ヘッダー行を解析
            const headers = parseCSVLine(lines[0]);
            
            // 列インデックスを特定
            const studentIdIdx = headers.indexOf('学籍番号');
            const xIdIdx = headers.indexOf('X ID（＠は無し）');
            const ytIdIdx = headers.indexOf('YTチャンネルID');
            
            if (studentIdIdx === -1 || xIdIdx === -1 || ytIdIdx === -1) {
                throw new Error('必要な列が見つかりません（学籍番号、X ID（＠は無し）、YTチャンネルID）');
            }
            
            // データ行を処理
            for (let i = 1; i < lines.length; i++) {
                if (!lines[i].trim()) continue;
                
                const row = parseCSVLine(lines[i]);
                
                if (row.length > Math.max(studentIdIdx, xIdIdx, ytIdIdx)) {
                    const studentId = (row[studentIdIdx] || '').trim();
                    const xId = (row[xIdIdx] || '').trim();
                    const ytId = (row[ytIdIdx] || '').trim();
                    
                    if (studentId) {
                        result.push(`${studentId}\t${ytId}\t${xId}`);
                    }
                }
            }
            
            return {
                data: result.join('\n'),
                count: result.length
            };
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i++;
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorDiv.classList.remove('hidden');
            resultDiv.classList.add('hidden');
        }
    </script>
</body>
</html>
